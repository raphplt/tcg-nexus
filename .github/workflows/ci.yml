name: CI/CD Pipeline

on:
    pull_request:
        branches:
            - main
            - develop
            - "**"
    push:
        branches:
            - main
            - develop
    workflow_call:

jobs:
    # Job pour le linting et la vérification des types
    lint-and-types:
        name: Lint & Type Check
        runs-on: ubuntu-latest

        steps:
            - name: Checkout code
              uses: actions/checkout@v4

            - name: Setup Node.js
              uses: actions/setup-node@v4
              with:
                  node-version: "20"
                  cache: "npm"

            - name: Install dependencies
              run: npm ci

            - name: Run lint
              run: npm run lint

            - name: Check types
              run: npm run check-types

    # Job pour les tests et build du backend
    backend:
        name: Backend Tests & Build
        runs-on: ubuntu-latest

        steps:
            - name: Checkout code
              uses: actions/checkout@v4

            - name: Setup Node.js
              uses: actions/setup-node@v4
              with:
                  node-version: "20"
                  cache: "npm"

            - name: Install dependencies
              run: npm ci

            - name: Run backend tests
              working-directory: apps/api
              run: npm test -- --coverage --passWithNoTests

            - name: Run backend e2e tests
              working-directory: apps/api
              run: npm run test:e2e -- --passWithNoTests
              continue-on-error: true

            - name: Build backend
              working-directory: apps/api
              run: npm run build

    # Job pour les tests et build du frontend
    frontend:
        name: Frontend Tests & Build
        runs-on: ubuntu-latest

        steps:
            - name: Checkout code
              uses: actions/checkout@v4

            - name: Setup Node.js
              uses: actions/setup-node@v4
              with:
                  node-version: "20"
                  cache: "npm"

            - name: Install dependencies
              run: npm ci

            - name: Check frontend types
              working-directory: apps/web
              run: npm run check-types

            - name: Lint frontend
              working-directory: apps/web
              run: npm run lint

            - name: Build frontend
              working-directory: apps/web
              env:
                  NEXT_PUBLIC_API_URL: ${{ secrets.NEXT_PUBLIC_API_URL || 'http://localhost:3001' }}
              run: npm run build

    # Job de build global avec Turbo (optionnel, pour vérifier que tout build ensemble)
    build-all:
        name: Build All
        runs-on: ubuntu-latest
        needs: [lint-and-types, backend, frontend]

        steps:
            - name: Checkout code
              uses: actions/checkout@v4

            - name: Setup Node.js
              uses: actions/setup-node@v4
              with:
                  node-version: "20"
                  cache: "npm"

            - name: Install dependencies
              run: npm ci

            - name: Build all packages
              env:
                  NEXT_PUBLIC_API_URL: ${{ secrets.NEXT_PUBLIC_API_URL || 'http://localhost:3001' }}
              run: npm run build
